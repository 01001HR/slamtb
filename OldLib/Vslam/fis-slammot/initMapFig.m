% INITMAPFIG  Initialize visualization

robotSize  = 1;

renderer = 'painters';
% renderer = 'zbuffer';
% renderer = 'opengl';

bgndcolor = 'w';
bgndcolor = .7*[1 1 1];

xSize = 20;
ySize = 12;

initObserver;

% FIGURE 1
fig1 = figure(1);
clf;
set(fig1,...
    'position',[624 1 400 250],...
    'doublebuffer','on',...
    'renderer',renderer,...
    'toolbar','none',...
    'color',bgndcolor);
cameratoolbar('show');
cameratoolbar('setmode','orbit');

% Axes
axis equal
ax1 = gca;
set(ax1,...
    'parent',fig1,...
    'position',[0 0 1 1],...
    'drawmode','fast',...
    'nextplot','replacechildren',...
    'projection',mapProj,...
	'CameraPosition',obsCam.X(1:WDIM),...
	'CameraPositionMode','manual',...
	'CameraTarget',obsTgt.X(1:WDIM),...
	'CameraTargetMode','manual',...
	'CameraUpVector',obsCam.upvec,...
	'CameraUpVectorMode','manual',...
	'CameraViewAngle',obsCam.a,...
	'CameraViewAngleMode','manual',...
    'xlim',[-1 500],...
    'ylim',[-70 70],...
    'zlim',[-10 90],...
    'xcolor',bgndcolor,...
    'ycolor',bgndcolor,...
    'zcolor',bgndcolor,...
    'color',bgndcolor);


% Ground
[x,y] = meshgrid(0:2:xSize,-ySize/2:2:ySize/2);
z = zeros(size(x));
sh = surface(...
    'parent',ax1,...
    'XData',x,...
    'YData',y,...
    'ZData',z,...
    'FaceColor','none',...
    'EdgeColor',[.6 .8 .8],...
    'Marker','none');



% Estimated robot
Rob.graphics = thickVehicle(robotSize);
[te,Re] = getTR(Rob);
Te = te*ones(1,6);
Rob.graphics.vert = Rob.graphics.vert0*Re'+Te'; 
dispEstRob = patch(...
    'parent'   ,ax1,...
    'vertices' ,Rob.graphics.vert,...
    'faces'    ,Rob.graphics.faces,...
    'facecolor','b',...
    'visible'  ,'on'); % solid blue robot estimate

% Camera in estimated robot
camBase      = [0;0;0];
for c = 1:length(Cam)
    camSensor    = Cam(c).X(1:WDIM);
    camPletine   = [camBase(1:2);camSensor(3)];
    Cam(c).graphics = fromFrame(...
        Rob,...
        [camBase camPletine camSensor camPletine]);
end
camGraph = [Cam.graphics];
dispEstCam   = line(...
    'parent'   	     ,ax1,...
    'xdata'          ,camGraph(1,:),...
    'ydata'          ,camGraph(2,:),...
    'zdata'          ,camGraph(3,:),...
    'linestyle'      ,'-',...
    'marker'         ,'none',...
    'color'          ,'m',...
    'visible'        ,'on'     ); % camera optical centers
    

% Map usage plot
if plotUsed
ax2 = axes(...
    'parent',fig1,...
    'position',[.07 .01 .45 .06],...
    'fontsize',7,...
    'fontweight','normal',...
    'xaxislocation','top',...
    'xcolor',[.4 .7 .4],...
    'ycolor',[.7 .4 .4],...
    'ticklength',[0 .02],...
    'ytick',[0.2 0.9],...
    'yticklabel',['FREE';'USED'],...
    'ylim',[0 1.1]);
    
    % usage in blue
    usedLm = line(...
        'parent',ax2,...
        'color','b',...
        'linewidth',1,...
        'xdata',1:Map.N,...
        'ydata',zeros(1,Map.N));
    
    % max used in red
    maxLm = line(...
        'parent',ax2,...
        'color','r',...
        'linewidth',3,...
        'xdata',[0 0],...
        'ydata',[0 1]);
    
    % set to main figure for camera control
    set(fig1,'currentaxes',ax1);
    
end

% Landmarks in map figure
initDrawMapLmks;
initDrawObjs;


